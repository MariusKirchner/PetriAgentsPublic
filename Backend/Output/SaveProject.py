__author__ = "Marius Kirchner, Goethe University Frankfurt am Main"

from xml.dom import minidom, Node
def saveProject(mainProject, filehandler):
    doc = minidom.Document()
    doc.appendChild(doc.createComment("PetriAgent Project created with PetriAgents Version 1.0.0, Release Date: 3rd of December 2025"))
    project = doc.createElement("Project")
    doc.appendChild(project)

    settings = doc.createElement("Settings")
    project.appendChild(settings)
    maxXCor = doc.createElement("maxXCor")
    settings.appendChild(maxXCor)
    maxXCor.appendChild(doc.createTextNode(str(mainProject.maxXCor)))
    maxYCor = doc.createElement("maxYCor")
    settings.appendChild(maxYCor)
    maxYCor.appendChild(doc.createTextNode(str(mainProject.maxYCor)))
    ticks = doc.createElement("Ticks")
    settings.appendChild(ticks)
    ticks.appendChild(doc.createTextNode(str(mainProject.ticks)))
    lrCont = doc.createElement("lrCont")
    settings.appendChild(lrCont)
    lrCont.appendChild(doc.createTextNode(str(mainProject.lrCont)))
    tbCont = doc.createElement("tbCont")
    settings.appendChild(tbCont)
    tbCont.appendChild(doc.createTextNode(str(mainProject.tbCont)))
    diffRate = doc.createElement("diffRate")
    settings.appendChild(diffRate)
    diffRate.appendChild(doc.createTextNode(str(mainProject.diffRate)))
    diffBool = doc.createElement("diffBool")
    settings.appendChild(diffBool)
    diffBool.appendChild(doc.createTextNode(str(mainProject.diffBool)))
    flowRate = doc.createElement("flowRate")
    settings.appendChild(flowRate)
    flowRate.appendChild(doc.createTextNode(str(mainProject.flowRate)))
    flowDir = doc.createElement("flowDir")
    settings.appendChild(flowDir)
    flowDir.appendChild(doc.createTextNode(str(mainProject.flowDir)))
    flowBool = doc.createElement("flowBool")
    settings.appendChild(flowBool)
    flowBool.appendChild(doc.createTextNode(str(mainProject.flowBool)))
    molOutFlowNorthBool = doc.createElement("molOutFlowNorth")
    settings.appendChild(molOutFlowNorthBool)
    molOutFlowNorthBool.appendChild(doc.createTextNode(str(mainProject.moleculeOutFlowNorth)))
    molOutFlowEastBool = doc.createElement("molOutFlowEast")
    settings.appendChild(molOutFlowEastBool)
    molOutFlowEastBool.appendChild(doc.createTextNode(str(mainProject.moleculeOutFlowEast)))
    molOutFlowSouthBool = doc.createElement("molOutFlowSouth")
    settings.appendChild(molOutFlowSouthBool)
    molOutFlowSouthBool.appendChild(doc.createTextNode(str(mainProject.moleculeOutFlowSouth)))
    molOutFlowWestBool = doc.createElement("molOutFlowWest")
    settings.appendChild(molOutFlowWestBool)
    molOutFlowWestBool.appendChild(doc.createTextNode(str(mainProject.moleculeOutFlowWest)))
    bacOutFlowNorthBool = doc.createElement("bacOutFlowNorth")
    settings.appendChild(bacOutFlowNorthBool)
    bacOutFlowNorthBool.appendChild(doc.createTextNode(str(mainProject.bacteriaOutflowNorth)))
    bacOutFlowEastBool = doc.createElement("bacOutFlowEast")
    settings.appendChild(bacOutFlowEastBool)
    bacOutFlowEastBool.appendChild(doc.createTextNode(str(mainProject.bacteriaOutflowEast)))
    bacOutFlowSouthBool = doc.createElement("bacOutFlowSouth")
    settings.appendChild(bacOutFlowSouthBool)
    bacOutFlowSouthBool.appendChild(doc.createTextNode(str(mainProject.bacteriaOutflowSouth)))
    bacOutFlowWestBool = doc.createElement("bacOutFlowWest")
    settings.appendChild(bacOutFlowWestBool)
    bacOutFlowWestBool.appendChild(doc.createTextNode(str(mainProject.bacteriaOutflowWest)))
    bacFlowRate = doc.createElement("bacFlowRate")
    settings.appendChild(bacFlowRate)
    bacFlowRate.appendChild(doc.createTextNode(str(mainProject.bacFlowRate)))
    bacDiffRate = doc.createElement("bacDiffRate")
    settings.appendChild(bacDiffRate)
    bacDiffRate.appendChild(doc.createTextNode(str(mainProject.bacDiffRate)))
    diffmode = doc.createElement("diffmode")
    settings.appendChild(diffmode)
    diffmode.appendChild(doc.createTextNode(str(mainProject.diffmode)))
    bacRotDiff = doc.createElement("bacRotDiff")
    settings.appendChild(bacRotDiff)
    bacRotDiff.appendChild(doc.createTextNode(str(mainProject.bacRotDiff)))
    bacVelo = doc.createElement("bacVelo")
    settings.appendChild(bacVelo)
    bacVelo.appendChild(doc.createTextNode(str(mainProject.bacVelo)))
    diffConstant = doc.createElement("diffConstant")
    settings.appendChild(diffConstant)
    diffConstant.appendChild(doc.createTextNode(str(mainProject.diffConstant)))
    patchLength = doc.createElement("patchLength")
    settings.appendChild(patchLength)
    patchLength.appendChild(doc.createTextNode(str(mainProject.patchLength)))
    timePerTickDefault = doc.createElement("timePerTickDefault")
    settings.appendChild(timePerTickDefault)
    timePerTickDefault.appendChild(doc.createTextNode(str(mainProject.timePerTickDefault)))
    colorDict = {19:"Red", 29:"Orange", 39:"Brown", 49:"Yellow", 59:"Green", 69:"Lime", 79:"Turqouise", 89:"Cyan", 99:"LightBlue", 109:"Blue", 119:"Violet", 129:"Magenta", 139:"Pink"}
    patchColor = doc.createElement("patchColor")
    settings.appendChild(patchColor)
    patchColor.appendChild(doc.createTextNode(colorDict[mainProject.patchColor]))
    patchColorIncrement = doc.createElement("patchColorIncrement")
    settings.appendChild(patchColorIncrement)
    patchColorIncrement.appendChild(doc.createTextNode(str(mainProject.patchColorIncrement)))
    patchColorMolecule = doc.createElement("patchColorMolecule")
    settings.appendChild(patchColorMolecule)
    patchColorMolecule.appendChild(doc.createTextNode(str(mainProject.patchColorMolecule)))

    #todo make output readable by naming the single nodes
    flows = doc.createElement("flows")
    project.appendChild(flows)
    for flow in mainProject.flows:
        newflow = doc.createElement("Flow")
        flows.appendChild(newflow)
        molecule = doc.createElement("Molecule")
        molecule.appendChild(doc.createTextNode(flow.molecule.moleculeName))
        newflow.appendChild(molecule)
        inout = doc.createElement("Inout")
        inout.appendChild(doc.createTextNode(str(flow.inout)))
        newflow.appendChild(inout)
        time = doc.createElement("Time")
        time.appendChild(doc.createTextNode(str(flow.time)))
        newflow.appendChild(time)
        starttime = doc.createElement("StartTime")
        starttime.appendChild(doc.createTextNode(str(flow.starttime)))
        newflow.appendChild(starttime)
        endtime = doc.createElement("EndTime")
        endtime.appendChild(doc.createTextNode(str(flow.endtime)))
        newflow.appendChild(endtime)
        amount = doc.createElement("Amount")
        amount.appendChild(doc.createTextNode(str(flow.amount)))
        newflow.appendChild(amount)
        area = doc.createElement("Area")
        area.appendChild(doc.createTextNode(str(flow.area)))
        newflow.appendChild(area)
        start = doc.createElement("Start")
        start.appendChild(doc.createTextNode(str(flow.start)))
        newflow.appendChild(start)
        end = doc.createElement("End")
        end.appendChild(doc.createTextNode(str(flow.end)))
        newflow.appendChild(end)

    #todo include initial settings for bacteria and environmentmolecules

    bacteria = doc.createElement("bacteria")
    project.appendChild(bacteria)
    for id in mainProject.listOfBacteriaIDs:
        tempBac = doc.createElement("Bacteria")
        tempBacName = doc.createElement("BacName")
        tempBac.appendChild(tempBacName)
        tempBacName.appendChild(doc.createTextNode(mainProject.bacteriaIDDict[id].name))
        tempBacMOI = doc.createElement("BacMOI")
        tempBac.appendChild(tempBacMOI)
        tempBacMOI.appendChild(doc.createTextNode(mainProject.bacteriaIDDict[id].MOI))
        tempBacShape = doc.createElement("BacShape")
        tempBac.appendChild(tempBacShape)
        tempBacShape.appendChild(doc.createTextNode(mainProject.bacteriaIDDict[id].shapeRepresentation))
        tempBacColor = doc.createElement("BacColor")
        tempBac.appendChild(tempBacColor)
        tempBacColor.appendChild(doc.createTextNode(str(mainProject.bacteriaIDDict[id].colorRepresentation)))
        tempPetri = mainProject.bacteriaIDDict[id].petriNet
        places = doc.createElement("places")
        tempBac.appendChild(places)
        for placeID in tempPetri.placeIDList:
            tempPlace = doc.createElement("Place")
            tempPlaceID = doc.createElement("PlaceID")
            tempPlace.appendChild(tempPlaceID)
            tempPlaceID.appendChild(doc.createTextNode(str(placeID)))
            tempPlaceName = doc.createElement("PlaceName")
            tempPlace.appendChild(tempPlaceName)
            tempPlaceName.appendChild(doc.createTextNode(tempPetri.placeDict[placeID].name))
            tempPlaceWeight = doc.createElement("PlaceTokens")
            tempPlace.appendChild(tempPlaceWeight)
            tempPlaceWeight.appendChild(doc.createTextNode(str(tempPetri.placeDict[placeID].tokens)))
            places.appendChild(tempPlace)
        transitions = doc.createElement("transitions")
        tempBac.appendChild(transitions)
        for transID in tempPetri.transitionIDList:
            tempTransition = doc.createElement("Transition")
            tempTransitionID = doc.createElement("TransID")
            tempTransition.appendChild(tempTransitionID)
            tempTransitionID.appendChild(doc.createTextNode(str(transID)))
            tempTransitionName = doc.createElement("TransitionName")
            tempTransition.appendChild(tempTransitionName)
            tempTransitionName.appendChild(doc.createTextNode(tempPetri.transitionDict[transID].name))
            transitions.appendChild(tempTransition)
        #TODO all IDs seperate, edgeIDs are horrible, maybe two dicts (one to target with info, one for id)
        currid = 0
        edges = doc.createElement("edges")
        tempBac.appendChild(edges)
        for edgeID in tempPetri.edgeIDList:
            tempEdge = doc.createElement("Edge")
            tempEdgeID = doc.createElement("EdgeID")
            tempEdge.appendChild(tempEdgeID)
            tempEdgeID.appendChild(doc.createTextNode(str(currid)))
            tempEdgeWeight = doc.createElement("EdgeWeight")
            tempEdge.appendChild(tempEdgeWeight)
            tempEdgeWeight.appendChild(doc.createTextNode(str(tempPetri.edgeDict[edgeID].weight)))
            tempEdgeSource = doc.createElement("EdgeSource")
            tempEdge.appendChild(tempEdgeSource)
            tempEdgeSource.appendChild(doc.createTextNode(str(tempPetri.edgeDict[edgeID].source)))
            tempEdgeSink = doc.createElement("EdgeSink")
            tempEdge.appendChild(tempEdgeSink)
            tempEdgeSink.appendChild(doc.createTextNode(str(tempPetri.edgeDict[edgeID].sink)))
            tempEdgeType = doc.createElement("EdgeType")
            tempEdge.appendChild(tempEdgeType)
            tempEdgeType.appendChild(doc.createTextNode(tempPetri.edgeDict[edgeID].edgeType))
            edges.appendChild(tempEdge)
            currid += 1
        behPlaces = doc.createElement("BehaviourPlaces")
        tempBac.appendChild(behPlaces)
        #for behPlace in mainProject.bacteriaIDDict[id].listOfBehPlaceIDs:
        #    pass
        bacteria.appendChild(tempBac)
    envMols = doc.createElement("EnvironmentMolecules")
    project.appendChild(envMols)
    for envMol in mainProject.listOfEnvironmentMolecules:
        newenvMol = doc.createElement("EnvironmentMolecule")
        envMols.appendChild(newenvMol)
        moleculeName = doc.createElement("MoleculeName")
        moleculeName.appendChild(doc.createTextNode(mainProject.dictOfEnvironmentMolecules[envMol].moleculeName))
        newenvMol.appendChild(moleculeName)
        distributionArea = doc.createElement("DistributionArea")
        fixedString = str(mainProject.dictOfEnvironmentMolecules[envMol].distArea).replace("'", "")
        distributionArea.appendChild(doc.createTextNode(fixedString))
        newenvMol.appendChild(distributionArea)
        distributionAmount = doc.createElement("DistributionAmount")
        distributionAmount.appendChild(doc.createTextNode(str(mainProject.dictOfEnvironmentMolecules[envMol].distAmount)))
        newenvMol.appendChild(distributionAmount)

    #doc = doc.toxml()
    doc = doc.toprettyxml()
    file = open(filehandler, mode="w")
    file.write(doc)
    file.close()
    print("Saving")
